<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">
    <!-- Bootstrap core CSS -->
    <link rel='stylesheet' href='/stylesheets/bootstrap.min.css'/>
    <!-- Material Design Bootstrap -->
    <link rel='stylesheet' href='/stylesheets/mdb.min.css'/>
    <!-- Footable CSS -->
    <link rel='stylesheet' href='/stylesheets/footable.bootstrap.css'/>
    <!-- Animate CSS -->
    <link rel='stylesheet' href='/stylesheets/animations.css'/>
    <!-- Loading CSS -->
    <link rel='stylesheet' href='/stylesheets/jquery.loading.css'/>
    <!-- custom styles -->
    <link rel='stylesheet' href='/stylesheets/style.css'/>

</head>
<body class="fadeIn">

<div id="nanobar"></div>
<section class="foodsafty container-fluid">
    <!--標題背景顏色-->
    <div class="stripe"></div>
    <!--資料來源-->
    <div class="source fadeInRight">
        <div class="align-content-center">
            <h5 class="">- 資料來源 -</h5>
            <span class="">智慧農業4.0共通平台</span>
        </div>
    </div>
    <!--標題-->
    <div class="container pt-2">
        <div class="card fadeInDown p-2">
            <div class="section-heading text-center">
                <h1 class="font-weight-bold">食品安全標章查詢</h1>
                <img class="img-fluid" src="/images/labels.png" alt="">
            </div>

            <!--搜尋條件-->
            <div class="search text-center">
                <p class="grey-text">步驟一: 請選擇標章類型</p>
                <div class="options mb-2">
                    <% fs_options.forEach(function(option, i){ %>
                    <button id="option<%= i %>" class="fs_option m-1 d-inline-block"><h5
                                class="fs_option_name m-auto"><%= option %></h5>
                    </button>
                    <% }) %>
                </div>
                <div id="step2" class="hidden">
                    <div class="d-flex flex-row justify-content-center mb-1">
                        <p class="grey-text mb-0 align-self-center">步驟二: 請輸入</p>
                        <h3><span class="m-3 badge selected-names align-self-center"></span></h3>
                        <p class="grey-text mb-0 align-self-center">標章號碼</p>
                    </div>
                    <div class="col-xs-12 col-md-8 m-auto search">
                        <input id="traceCode" class="search_input" name="traceCode" type="text"
                               placeholder="驗證合格可供識別或追查之號碼"  data-mask-reverse="true" >
                        <div class="text-center hidden" id="pork_traceCode">
                            <input id="traceCode1" class="search_input d-inline-block col-3" name="traceCode"
                                   type="text"
                                   placeholder="輸入 4 碼">－
                            <input id="traceCode2" class="search_input d-inline-block col-3" name="traceCode"
                                   type="text"
                                   placeholder="輸入 4 碼">
                        </div>
                        <button class="flexsearch_submit p-2 btn btn-default" type="button" onclick="flexsearchSubmit()"
                                data-toggle="modal">送出查詢
                            <!--<span class="fa fa-search"></span>-->
                        </button>
                        <div class="err_msg mb-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--搜尋結果-->
    <div class="container mt-3 results hidden">
        <div class="tables table-responsive">
            <table id="factory_table" class="table table-striped table-bordered" data-paging="true">
            </table>
            <table id="product_table" class="table table-striped table-bordered" data-paging="true">
            </table>

            <!--下面四個table只有tap會使用-->
            <table id="tap_table1" class="table table-striped table-bordered hidden" data-paging="true">
            </table>
            <table id="tap_table2" class="table table-striped table-bordered hidden" data-paging="true">
            </table>
            <table id="tap_table3" class="table table-striped table-bordered hidden" data-paging="true">
            </table>
            <table id="tap_table4" class="table table-striped table-bordered hidden" data-paging="true">
            </table>

            <!--下面table只有pts會使用-->
            <table id="pts_table" class="table table-striped table-bordered hidden" data-paging="true">
            </table>
        </div>
    </div>
</section>
<br>


<script src='/javascripts/jquery-3.1.1.min.js'></script>
<script src='/javascripts/jquery.loading.js'></script>
<script src='/javascripts/jquery.mask.min.js'></script>
<script src='/javascripts/tether.min.js'></script>
<script src='/javascripts/bootstrap.min.js'></script>
<script src='/javascripts/footable.min.js'></script>
<script src='/javascripts/mdb.min.js'></script>
<script src='/javascripts/nanobar.js'></script>
<script>

    var baseUrl = 'http://140.110.30.110:8080/';
    //    var baseUrl = 'http://140.92.25.47:8080/';
    var options = {
        id: 'nanobar'
    };
    var nanobar = new Nanobar(options);

    $(document).ready(function () {

        $('.fs_option').click(function () {
            $('#step2').removeClass('hidden');

            $(this).addClass('option_selected').siblings().removeClass('option_selected');

//            取得選擇btn的標章名稱
            var name = $(this).find('h5').text();
            $('.selected-names').text(name);

            var optionSelected = $('.option_selected').attr('id');
            var traceCode_input = $('#traceCode');



            if (optionSelected == 'option7') {
                $('#traceCode').addClass('hidden');
                $('#pork_traceCode').removeClass('hidden');
            } else {
                $('#traceCode').removeClass('hidden');
                $('#pork_traceCode').addClass('hidden');
                //避免切換時，空白input也能送出，所以要清空隱藏的input欄位
                $('#pork_traceCode').find('input').val('');
            }

            if (optionSelected == 'option0') {
                traceCode_input.attr('placeholder', '請輸入 6 碼阿拉伯數字');
                traceCode_input.attr('maxlength', '6');
            } else if (optionSelected == 'option2') {
                traceCode_input.attr('placeholder', '請輸入CAS 驗證機構英文簡稱 + 7 碼 阿拉伯數字');
                traceCode_input.attr('maxlength', '');
            } else if (optionSelected == 'option3') {
                traceCode_input.attr('placeholder', '請輸入 9 碼阿拉伯數字');
                traceCode_input.attr('maxlength', '9');
            } else if (optionSelected == 'option4') {
                traceCode_input.attr('placeholder', '請輸入 10 碼阿拉伯數字');
                traceCode_input.attr('maxlength', '10');
            } else if (optionSelected == 'option5') {
                traceCode_input.attr('placeholder', '請輸入牛隻耳標號碼');
                traceCode_input.attr('maxlength', '');
            } else if (optionSelected == 'option6') {
                traceCode_input.attr('placeholder', '請輸入 10 碼阿拉伯數字');
                traceCode_input.attr('maxlength', '10');
            } else if (optionSelected == 'option8') {
                traceCode_input.attr('placeholder', '請輸入 10 碼阿拉伯數字');
                traceCode_input.attr('maxlength', '10');
            } else {
                traceCode_input.attr('placeholder', '請輸入驗證合格可供識別或追查之號碼');
                traceCode_input.attr('maxlength', '');
            }
        })
    });

    function init() {
        $('#factory_table').html('');
        $('#product_table').html('');
        $('#tap_table1').html('');
        $('#tap_table2').html('');
        $('#tap_table3').html('');
        $('#tap_table4').html('');
        $('#pts_table').html('');
        $('h5.tap_head').html('');
    }

    function flexsearchSubmit() {
        $('.results').loading({
            theme: 'light',
            message: 'Working...'
        });
        init();
        var optionSelected = $('.option_selected').attr('id');
        var traceCode = $('#traceCode').val().replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g, '-').replace(/^(-)+|(-)+$/g, '');
        var traceCode1 = $('#traceCode1').val().replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g, '-').replace(/^(-)+|(-)+$/g, '');
        var traceCode2 = $('#traceCode2').val().replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g, '-').replace(/^(-)+|(-)+$/g, '');
        var isValid = true;

        if (optionSelected) {

            if (optionSelected == 'option1') {
                $('table[id^="tap_table"]').removeClass('hidden');
            } else {
                $('table[id^="tap_table"]').html('');
                $('table[id^="tap_table"]').addClass('hidden');
            }

            if (optionSelected == 'option4') {
                $('#pts_table').removeClass('hidden');
            } else {
                $('#pts_table').html('');
                $('#pts_table').addClass('hidden');
            }

            if (traceCode || (traceCode1 && traceCode2)) {

                $('.err_msg').html('');

                var f_columns = [];
                var p_columns = [];
                var url = '';

                if (optionSelected == 'option0') {

                    isValid = validationLen(traceCode, 6);
                    url = 'api/cas/' + traceCode + '/findByEmblemID';
                    f_columns = [
                        {
                            name: "Factory_CName",
                            title: "行號名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "Factory_Director",
                            title: "負責人",
                            breakpoints: "xs sm"
                        }, {
                            name: "Factory_Address",
                            title: "公司地址",
                            breakpoints: "xs sm"
                        }, {
                            name: "Factory_Tel",
                            title: "聯絡電話",
                            breakpoints: "xs sm"
                        }, {
                            name: "Factory_Fax",
                            title: "傳真號碼",
                            breakpoints: "xs sm"
                        }
                    ];
                    p_columns = [
                        {
                            name: "Material_Name",
                            title: "產品類別",
                            breakpoints: "xs sm"
                        }, {
                            name: "PType_Name",
                            title: "產品種類",
                            breakpoints: "xs sm"
                        }, {
                            name: "Product_Name",
                            title: "產品名稱",
                            breakpoints: "xs sm"
                        }
                    ];
                } else if (optionSelected == 'option1') {
                    url = 'api/FS_taps/' + traceCode + '/findByTraceCode';
                    f_columns = [
                        {
                            name: "Producer",
                            title: "經營業者",
                            breakpoints: "xs sm"
                        }, {
                            name: "FarmerName",
                            title: "生產者姓名",
                            breakpoints: "xs sm"
                        }, {
                            name: "ProductName",
                            title: "產品名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "Place",
                            title: "產地",
                            breakpoints: "xs sm"
                        }, {
                            name: "PackDate",
                            title: "包裝日期",
                            breakpoints: "xs sm"
                        }, {
                            name: "ValidDate",
                            title: "驗證效期",
                            breakpoints: "xs sm"
                        }, {
                            name: "CertificationName",
                            title: "驗證機構",
                            breakpoints: "xs sm"
                        }
                    ];
                } else if (optionSelected == 'option2') {
                    url = 'api/FS_OrganicAgris/' + traceCode + '/findByVerifyCode';
                    f_columns = [
                        {
                            name: "verifyOrg",
                            title: "驗證機構",
                            breakpoints: "xs sm"
                        }, {
                            name: "expiration",
                            title: "驗證效期",
                            breakpoints: "xs sm"
                        }, {
                            name: "status",
                            title: "驗證狀態",
                            breakpoints: "xs sm"
                        }
                    ];
                    p_columns = [
                        {
                            name: "operatorName",
                            title: "經營業者名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "operatorAddress",
                            title: "經營業者地址",
                            breakpoints: "xs sm"
                        }, {
                            name: "contactPhone",
                            title: "經營業者電話",
                            breakpoints: "xs sm"
                        }, {
                            name: "verifyManner",
                            title: "加工/分裝/流通",
                            breakpoints: "xs sm"
                        }, {
                            name: "productName",
                            title: "產品品項",
                            breakpoints: "all"
                        }
                    ];
                } else if (optionSelected == 'option3') {
                    isValid = validationLen(traceCode, 9);
                    url = 'api/gaps/' + traceCode + '/findByGapLabel';
                    f_columns = [
                        {
                            name: "className",
                            title: "產銷班名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "orgName",
                            title: "輔導單位",
                            breakpoints: "xs sm"
                        }, {
                            name: "mainClassName",
                            title: "產業別",
                            breakpoints: "xs sm"
                        }, {
                            name: "county",
                            title: "縣市別",
                            breakpoints: "xs sm"
                        }
                    ];
                } else if (optionSelected == 'option4') {
                    isValid = validationLen(traceCode, 10);
                    url = 'api/pts/' + traceCode + '/findByTraceCode';
                    f_columns = [
                        {
                            name: "modifyTime",
                            title: "驗證日期",
                            breakpoints: "xs"
                        }, {
                            name: "producer",
                            title: "生產者",
                            breakpoints: "xs"
                        }, {
                            name: "telephone",
                            title: "聯絡電話",
                            breakpoints: "xs sm"
                        }, {
                            name: "address",
                            title: "聯絡地址",
                            breakpoints: "xs sm"
                        }, {
                            name: "email",
                            title: "電子郵件",
                            breakpoints: "xs sm"
                        }, {
                            name: "url",
                            title: "網址",
                            breakpoints: "all"
                        }, {
                            name: "description",
                            title: "簡介",
                            breakpoints: "all"
                        }
                    ];
                } else if (optionSelected == 'option5') {
                    url = 'api/FS_BeefTraces/' + traceCode + '/findByTraceID';
                    f_columns = [
                        {
                            name: "FarmName",
                            title: "畜牧場名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "Farmer",
                            title: "畜牧場負責人",
                            breakpoints: "xs sm"
                        }, {
                            name: "FarmID",
                            title: "畜牧場登記證號",
                            breakpoints: "xs sm"
                        }, {
                            name: "FarmAddress",
                            title: "畜牧場地址",
                            breakpoints: "xs sm"
                        }
                    ];
                    p_columns = [
                        {
                            name: "SlaughterDate",
                            title: "屠宰日期",
                            breakpoints: "xs sm"
                        }, {
                            name: "SlaughterPlace",
                            title: "屠宰場",
                            breakpoints: "xs sm"
                        }, {
                            name: "SlaughterAddress",
                            title: "屠宰場地址",
                            breakpoints: "xs sm"
                        }, {
                            name: "SlaughterPlaceOwner",
                            title: "屠宰場負責人",
                            breakpoints: "xs sm"
                        }, {
                            name: "SlaughterPlaceID",
                            title: "屠宰場登記證",
                            breakpoints: "xs sm"
                        }
                    ];
                } else if (optionSelected == 'option6') {
                    isValid = validationLen(traceCode, 10);
                    url = 'api/FS_TaftePoultries/' + traceCode + '/findByTraceno';
                    f_columns = [
                        {
                            name: "prod",
                            title: "產品名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "regno",
                            title: "登記號碼",
                            breakpoints: "xs sm"
                        }, {
                            name: "name",
                            title: "經營業者",
                            breakpoints: "xs sm"
                        }, {
                            name: "boss",
                            title: "生產者姓名",
                            breakpoints: "xs sm"
                        }, {
                            name: "addr",
                            title: "產地",
                            breakpoints: "xs sm"
                        }, {
                            name: "addr2",
                            title: "聯絡地址",
                            breakpoints: "xs sm"
                        }
                    ];
                    p_columns = [
                        {
                            name: "c01_name",
                            title: "禽種",
                            breakpoints: "xs sm"
                        }, {
                            name: "qty",
                            title: "飼養規模",
                            breakpoints: "xs sm"
                        }, {
                            name: "c02",
                            title: "飼養方式",
                            breakpoints: "xs sm"
                        }, {
                            name: "typical",
                            title: "特色",
                            breakpoints: "all"
                        }
                    ]
                } else if (optionSelected == 'option7') {

                    var reg1 = "^[A-Z]{2}[0-9]{2}$";
                    var reg2 = "^[0-9]{4}$";
                    isValid = traceCode1.match(reg1) && traceCode2.match(reg2);

                    url = 'api/FS_Porks/findByCode?Code1=' + traceCode1 + '&Code2=' + traceCode2;
                    f_columns = [
                        {
                            name: "marketName",
                            title: "拍賣市場",
                            breakpoints: "xs sm"
                        }, {
                            name: "farmName",
                            title: "來源畜牧場",
                            breakpoints: "xs sm"
                        }, {
                            name: "transDate",
                            title: "拍賣日期",
                            breakpoints: "xs sm"
                        }, {
                            name: "farmCity",
                            title: "畜牧場縣市",
                            breakpoints: "xs sm"
                        }, {
                            name: "farmTown",
                            title: "畜牧場鄉鎮",
                            breakpoints: "xs sm"
                        }, {
                            name: "msg",
                            title: "其他說明",
                            breakpoints: "xs sm"
                        }
                    ];
                } else if (optionSelected == 'option8') {
                    isValid = validationLen(traceCode, 10);
                    url = 'api/FS_Seafoods/' + traceCode + '/findByTraceNo';
                    f_columns = [
                        {
                            name: "AquaName",
                            title: "漁民姓名",
                            breakpoints: "xs sm"
                        }, {
                            name: "Tel",
                            title: "聯絡電話",
                            breakpoints: "xs sm"
                        }, {
                            name: "Addr",
                            title: "聯絡地址",
                            breakpoints: "xs sm"
                        }, {
                            name: "EMail",
                            title: "電子郵件",
                            breakpoints: "xs sm"
                        }, {
                            name: "ProdName",
                            title: "產品名稱",
                            breakpoints: "xs sm"
                        }, {
                            name: "Url",
                            title: "網址",
                            breakpoints: "all"
                        }, {
                            name: "Intro",
                            title: "簡介",
                            breakpoints: "all"
                        }
                    ];
                }

                if (isValid) {
                    //產生Table的function
                    generate(url, f_columns, p_columns, optionSelected);
                } else {
                    $('.err_msg').html('請檢查標章號碼長度');
                }

            } else {
                $('.err_msg').html('請輸入標章號碼');
            }
        } else {
            $('.err_msg').html('請先選擇標章類型');
        }
    }

    function generate(url, f_columns, p_columns, optionSelected) {

//        nanobar.go(50);
        $.ajax({
            url: baseUrl + url,
            type: 'GET',
            success: function (response) {

                $('.results').removeClass('hidden');
//                $('#another-loading').loading('stop');

//                setTimeout(function () {
//                    nanobar.go(100);

//                    $("html, body").animate({scrollTop: $('.results').offset().top}, 1000, 'easeInOutExpo');
//                }, 300);

                $('.results').on('loading.stop', function() {
                    $("html, body").animate({scrollTop: $('.results').offset().top}, 1000, 'easeInOutExpo');
                });
                var f_rows = [];
                var p_rows = [];

                if (response) {

                    $('<h5 class="tap_head">標章資訊</h5>').insertBefore($('#factory_table'));

                    if (Array.isArray(response)) {

                        f_rows.push(response[0]);

                    } else {
                        if (response !== "NO MATCH DATA!") {
                            f_rows.push(response);
                        }
                    }

                }

                $('#factory_table').footable({
                    "empty": "查無資料",
                    "toggleColumn": "last",
                    "expandFirst": true,
                    "visible": true,
                    "columns": f_columns,
                    "rows": f_rows,
                    "paging": {
                        "position": "right",
                        "size": 20
                    }
                });


                if (p_columns.length > 0) {

                    if (response) {
                        if (Array.isArray(response)) {
                            p_rows = response;
                        } else {
                            p_rows.push(response);
                        }
                    }

                    $('#product_table').footable({
                        "empty": "查無資料",
                        "toggleColumn": "last",
                        "expandFirst": true,
                        "columns": p_columns,
                        "rows": p_rows,
                        "paging": {
                            "position": "right",
                            "size": 10
                        }
                    });
                }

                if (optionSelected == 'option1') {

                    response = response[0];

                    if (response.ResumeDetail) {
                        var content = tap_transferTag_column(response.ResumeDetail.ResumeTag);

                        $('<h5 class="tap_head">履歷資訊</h5>').insertBefore($('#tap_table1'));
                        $('#tap_table1').footable({
                            "toggleColumn": "last",
                            "expandFirst": true,
                            "columns": content[0],
                            "rows": content[1],
                            "paging": {
                                "position": "right",
                                "size": 10
                            }
                        });
                    }

                    if (response.OperationDetail) {

                        var detailTag = [];
                        if (Array.isArray(response.OperationDetail.OperationTag)) {
                            detailTag = response.OperationDetail.OperationTag;
                        } else {
                            detailTag.push(response.OperationDetail.OperationTag);
                        }

                        $('<h5 class="tap_head">生產紀錄</h5>').insertBefore($('#tap_table2'));
                        $('#tap_table2').footable({
                            "toggleColumn": "last",
                            "expandFirst": true,
                            "columns": [{
                                name: "OperationDate",
                                title: "作業日期",
                                breakpoints: "xs sm"
                            }, {
                                name: "OperationType",
                                title: "作業種類",
                                breakpoints: "xs sm"
                            }, {
                                name: "Operation",
                                title: "作業內容",
                                breakpoints: "xs sm"
                            }],
                            "rows": detailTag,
                            "paging": {
                                "position": "right",
                                "size": 10
                            }
                        });
                    }

                    if (response.ProcessDetail) {

                        var detailTag = [];
                        if (Array.isArray(response.ProcessDetail.ProcessTag)) {
                            detailTag = response.ProcessDetail.ProcessTag;
                        } else {
                            detailTag.push(response.ProcessDetail.ProcessTag);
                        }

                        $('<h5 class="tap_head">加工資訊</h5>').insertBefore($('#tap_table3'));
                        $('#tap_table3').footable({
                            "toggleColumn": "last",
                            "expandFirst": true,
                            "columns": [{
                                name: "ProcessDate",
                                title: "作業日期",
                                breakpoints: "xs sm"
                            }, {
                                name: "ProcessItem",
                                title: "作業項目",
                                breakpoints: "xs sm"
                            }, {
                                name: "ProcessArea",
                                title: "作業場所",
                                breakpoints: "xs sm"
                            }, {
                                name: "ProcessMemo",
                                title: "備註",
                                breakpoints: "xs sm"
                            }],
                            "rows": detailTag,
                            "paging": {
                                "position": "right",
                                "size": 10
                            }
                        });
                    }

                    if (response.CertificateDetail) {

                        var detailTag = [];
                        if (Array.isArray(response.CertificateDetail.CertificateTag)) {
                            detailTag = response.CertificateDetail.CertificateTag;
                        } else {
                            detailTag.push(response.CertificateDetail.CertificateTag);
                        }

                        $('<h5 class="tap_head">其他驗證標章</h5>').insertBefore($('#tap_table4'));
                        $('#tap_table4').footable({
                            "toggleColumn": "last",
                            "expandFirst": true,
                            "columns": [{
                                name: "Certificate",
                                title: "其他標章",
                                breakpoints: "xs sm"
                            }],
                            "rows": detailTag,
                            "paging": {
                                "position": "right",
                                "size": 10
                            }
                        });
                    }

                }

                if (optionSelected == 'option4') {

                    if (response.productList) {
                        $('<h5 class="tap_head">產品資訊</h5>').insertBefore($('#pts_table'));

                        $('#pts_table').footable({
                            "toggleColumn": "last",
                            "expandFirst": true,
                            "columns": [
                                {
                                    name: "productName",
                                    title: "產品名稱",
                                    breakpoints: "xs sm"
                                }, {
                                    name: "place",
                                    title: "產地",
                                    breakpoints: "xs sm"
                                }
                            ],
                            "rows": response.productList,
                            "paging": {
                                "position": "right",
                                "size": 10
                            }
                        });
                    }

                }

            }, error: function (xhr) {
                console.log('Ajex request 發生錯誤');
            }
        })
    }

    function tap_transferTag_column(tags) {

        var columns = [];
        var row = {};

        tags.forEach(function (tag, i) {


            columns.push({
                name: "tag" + i,
                title: tag.ResumeTitle,
                breakpoints: "xs sm"
            });

            row["tag" + i] = tag.StoreInfo;

        });

        return [columns, [row]];
    }

    //正則表達式
    function validationLen(input_len, valid_len) {

        var reg = "^[0-9]{"+valid_len+"}$";
        return input_len.match(reg);
    }
</script>

</body>

</html>
